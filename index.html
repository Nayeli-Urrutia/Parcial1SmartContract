<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Propiedades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .welcome-screen {
            text-align: center;
            padding: 40px 0;
        }
        .welcome-title {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 40px;
        }
        .options-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
        }
        .option-button {
            padding: 20px 40px;
            font-size: 1.2em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .option-button:hover {
            transform: translateY(-3px);
            background-color: #2980b9;
        }
        .option-button.seller {
            background-color: #2ecc71;
        }
        .option-button.seller:hover {
            background-color: #27ae60;
        }
        .main-content {
            display: none;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        .sections-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .section {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .button.register {
            background-color: #2ecc71;
        }
        .button.register:hover {
            background-color: #27ae60;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 70%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close {
            float: right;
            cursor: pointer;
            font-size: 28px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .property-list {
            margin-top: 20px;
        }
        .property-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .property-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .transactions-table th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        .transactions-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .transaction-type {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .type-registro {
            background-color: #2ecc71;
            color: white;
        }
        .type-transferencia {
            background-color: #3498db;
            color: white;
        }
        .property-details {
            margin-top: 8px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="welcome-screen" id="welcomeScreen">
            <h1 class="welcome-title">Bienvenidos al Registro de Propiedades y Terrenos de Guatemala</h1>
            <div class="options-container">
                <button class="option-button seller" onclick="selectRole('seller')">Vendedor</button>
                <button class="option-button" onclick="selectRole('buyer')">Comprador</button>
            </div>
        </div>

        <div class="main-content" id="sellerContent" style="display: none;">
            <h1>Panel de Vendedor</h1>
            <button class="button" onclick="returnToHome()">Regresar al Inicio</button>
            <div class="section">
                <button class="button register" onclick="showRegisterPropertyModal()">Registrar Nueva Propiedad</button>
                <button class="button" onclick="showAvailableProperties('seller')">Ver Propiedades Disponibles</button>
            </div>
        </div>

        <div class="main-content" id="buyerContent" style="display: none;">
            <h1>Panel de Comprador</h1>
            <button class="button" onclick="returnToHome()">Regresar al Inicio</button>
            <div class="section">
                <button class="button" onclick="showAvailableProperties('buyer')">Ver Propiedades Disponibles</button>
            </div>
        </div>

            <div id="propertyListContainer" class="property-list"></div>
            <div id="transactionsContainer"></div>

        <!-- Modal para registrar propiedad -->
        <div id="registerPropertyModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('registerPropertyModal')">&times;</span>
                <h2>Registrar Nueva Propiedad</h2>
                <form id="registerPropertyForm" onsubmit="handleRegisterProperty(event)">
                    <div class="form-group">
                        <label for="propertyId">ID de Propiedad:</label>
                        <input type="text" id="propertyId" required>
                    </div>
                    <div class="form-group">
                        <label for="owner">Propietario:</label>
                        <input type="text" id="owner" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Ubicación:</label>
                        <input type="text" id="location" required>
                    </div>
                    <div class="form-group">
                        <label for="area">Área (metros cuadrados):</label>
                        <input type="number" id="area" required>
                    </div>
                    <div class="form-group">
                        <label for="value">Valor (Q):</label>
                        <input type="number" id="value" required>
                    </div>
                    <button type="submit" class="button register">Registrar Propiedad</button>
                </form>
            </div>
        </div>

        <!-- Modal para transferir propiedad -->
        <div id="transferPropertyModal" class="modal">
            <div class="modal-content">
e su terreno                <span class="close" onclick="closeModal('transferPropertyModal')">&times;</span>
                <h2 id="transferModalTitle">Comprar Propiedad</h2>
                <form id="transferPropertyForm" onsubmit="handleTransferProperty(event)">
                    <input type="hidden" id="transferPropertyId">
                    <input type="hidden" id="currentOwner">
                    <div class="form-group">
                        <label for="newOwner">Nombre del Cliente:</label>
                        <input type="text" id="newOwner" required>
                    </div>
                    <div class="form-group">
                        <label for="saleValue">Monto a Pagar:</label>
                        <input type="number" id="saleValue" style="display: none;" required>
                        <div class="price-display" style="font-size: 1.1em; margin-top: 5px;">Q<span id="saleValueDisplay"></span></div>
                    </div>
                    <button type="submit" class="button">Confirmar Compra</button>
                </form>
            </div>
        </div>

        <div id="loginModal" class="modal">
            <div class="modal-content">
                <h2>Iniciar Sesión</h2>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Usuario:</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="button register">Iniciar Sesión</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import SmartContract from './SmartContract.js';

        const contract = new SmartContract();
        window.contract = contract; // Make contract accessible globally

        let isSellerAuthenticated = false;
        const SELLER_CREDENTIALS = {
            username: "Nayeli_Urrutia",
            password: "1234"
        };

        window.showLoginModal = function() {
            document.getElementById('loginModal').style.display = 'block';
        };

        window.selectRole = function(role) {
            if (role === 'seller') {
                showLoginModal();
            } else {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('buyerContent').style.display = 'block';
                showAvailableProperties('buyer');
            }
        };

        window.handleLogin = async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === SELLER_CREDENTIALS.username && password === SELLER_CREDENTIALS.password) {
                isSellerAuthenticated = true;
                closeModal('loginModal');
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('sellerContent').style.display = 'block';
                showAvailableProperties('seller');
                alert('Inicio de sesión exitoso');
            } else {
                alert('Usuario o contraseña incorrectos');
            }
        };

        // Funciones para manejar los modales
        window.showRegisterPropertyModal = function() {
            if (!isSellerAuthenticated) {
                showLoginModal();
                return;
            }
            document.getElementById('registerPropertyModal').style.display = 'block';
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.showTransferModal = async function(propertyId, currentOwner, isSeller = false) {
            const properties = await contract.getProperties();
            const property = properties.find(p => p.id === propertyId);
            
            document.getElementById('transferPropertyId').value = propertyId;
            document.getElementById('currentOwner').value = currentOwner;
            document.getElementById('saleValue').value = property.value;
            document.getElementById('saleValueDisplay').textContent = property.value.toLocaleString();
            
            // Enable price editing for sellers during resale
            const saleValueInput = document.getElementById('saleValue');
            saleValueInput.readOnly = !isSeller;
            saleValueInput.style.display = isSeller ? 'block' : 'none';
            document.getElementById('saleValueDisplay').style.display = isSeller ? 'none' : 'block';
            
            document.getElementById('transferPropertyModal').style.display = 'block';
        };

        // Manejador para la transferencia de propiedades
        window.handleTransferProperty = async function(event) {
            event.preventDefault();
            const propertyId = document.getElementById('transferPropertyId').value;
            const currentOwner = document.getElementById('currentOwner').value;
            const newOwner = document.getElementById('newOwner').value;
            const saleValue = Number(document.getElementById('saleValue').value);

            const success = await contract.transferProperty(propertyId, currentOwner, newOwner, saleValue);
            if (success) {
                alert('Propiedad transferida exitosamente');
                closeModal('transferPropertyModal');
                document.getElementById('transferPropertyForm').reset();
                showAvailableProperties('buyer');
            } else {
                alert('Error: No se pudo transferir la propiedad');
            }
        };

        // Función para mostrar propiedades disponibles
        window.showAvailableProperties = async function(userType) {
            if (userType === 'seller' && !isSellerAuthenticated) {
                showLoginModal();
                return;
            }
            const properties = await contract.getProperties();
            const container = document.getElementById('propertyListContainer');
            container.innerHTML = '';

            if (userType === 'seller') {
                // Create sections for available and sold properties
                const availableSection = document.createElement('div');
                availableSection.innerHTML = '<h2>Propiedades Disponibles</h2>';
                const soldSection = document.createElement('div');
                soldSection.innerHTML = '<h2>Propiedades Vendidas</h2>';

                properties.forEach((property) => {
                    const propertyCard = createPropertyCard(property, userType);
                    if (property.status === 'sold') {
                        soldSection.appendChild(propertyCard);
                    } else {
                        availableSection.appendChild(propertyCard);
                    }
                });

                container.appendChild(availableSection);
                container.appendChild(soldSection);
            } else {
                // For buyers, only show available properties
                const availableProperties = properties.filter(p => p.status === 'available');
                availableProperties.forEach((property) => {
                    const propertyCard = createPropertyCard(property, userType);
                    container.appendChild(propertyCard);
                });
            }

        function createPropertyCard(property, userType) {
            const propertyCard = document.createElement('div');
            propertyCard.className = 'property-card';
            propertyCard.innerHTML = `
                <h3>Propiedad ${property.id}</h3>
                <div><strong>Propietario:</strong> ${property.owner}</div>
                <div><strong>Ubicación:</strong> ${property.location}</div>
                <div><strong>Área:</strong> ${property.area} metros cuadrados</div>
                <div><strong>Valor:</strong> Q${property.value}</div>
                ${userType === 'seller' ? 
                    `<button class="button" onclick="showTransferModal('${property.id}', '${property.owner}', true)">Vender Propiedad</button>`
                : `<button class="button" onclick="showTransferModal('${property.id}', '${property.owner}')">Comprar Propiedad</button>`
                }
                <button class="button" onclick="showPropertyHistory('${property.id}')">Ver Historial</button>
            `;
            return propertyCard;
            }

            // Limpiar el contenedor de transacciones
            document.getElementById('transactionsContainer').innerHTML = '';
        };

        // Función para mostrar el historial de una propiedad
        window.showPropertyHistory = async function(propertyId) {
            const transactions = await contract.getTransactions();
            const propertyTransactions = transactions
                .filter(t => t.property_id === propertyId)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const container = document.getElementById('transactionsContainer');
            const table = document.createElement('table');
            table.className = 'transactions-table';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Detalles</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            propertyTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                const date = new Date(transaction.timestamp).toLocaleDateString('es-GT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                let details = '';
                if (transaction.type === 'REGISTRO') {
                    details = `
                        <div><strong>Propietario:</strong> ${transaction.owner}</div>
                        <div class="property-details">
                            <div>Ubicación: ${transaction.location}</div>
                            <div>Área: ${transaction.area} metros cuadrados</div>
                            <div>Valor: Q${transaction.value}</div>
                        </div>
                    `;
                } else if (transaction.type === 'TRANSFERENCIA') {
                    details = `
                        <div><strong>Vendedor:</strong> ${transaction.previousOwner}</div>
                        <div><strong>Comprador:</strong> ${transaction.newOwner}</div>
                        <div class="property-details">Valor de Venta: Q${transaction.saleValue}</div>
                    `;
                }

                tr.innerHTML = `
                    <td>${date}</td>
                    <td>
                        <span class="transaction-type type-${transaction.type.toLowerCase()}">
                            ${transaction.type}
                        </span>
                    </td>
                    <td>${details}</td>
                `;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.innerHTML = '<h2>Historial de la Propiedad</h2>';
            container.appendChild(table);
        };

        // Manejador para el registro de propiedades
        window.handleRegisterProperty = async function(event) {
            event.preventDefault();
            const propertyId = document.getElementById('propertyId').value;
            const owner = document.getElementById('owner').value;
            const location = document.getElementById('location').value;
            const area = Number(document.getElementById('area').value);
            const value = Number(document.getElementById('value').value);

            const success = await contract.registerProperty(propertyId, owner, location, area, value);
            if (success) {
                alert('Propiedad registrada exitosamente');
                closeModal('registerPropertyModal');
                document.getElementById('registerPropertyForm').reset();
                showAvailableProperties('seller');
            } else {
                alert('Error: La propiedad ya existe');
            }
        };

        // Manejador para la transferencia de propiedades
        window.handleTransferProperty = async function(event) {
            event.preventDefault();
            const propertyId = document.getElementById('transferPropertyId').value;
            const currentOwner = document.getElementById('currentOwner').value;
            const newOwner = document.getElementById('newOwner').value;
            const saleValue = Number(document.getElementById('saleValue').value);

            // For buyers, check spending limit
            if (!isSellerAuthenticated) {
                const SPENDING_LIMIT = 1000000;
                if (saleValue > SPENDING_LIMIT) {
                    alert('Fondos insuficientes. El límite de compra es Q1,000,000');
                    return;
                }
            }

            const success = await contract.transferProperty(propertyId, currentOwner, newOwner, saleValue);
            if (success) {
                closeModal('transferPropertyModal');
                document.getElementById('transferPropertyForm').reset();
                
                if (!isSellerAuthenticated) {
                    const result = confirm('¡Felicitaciones por tu compra!\n\nPresiona OK para continuar comprando\nPresiona Cancelar para cerrar sesión');
                    if (result) {
                        showAvailableProperties('buyer');
                    } else {
                        returnToHome();
                    }
                } else {
                    alert('Propiedad transferida exitosamente');
                    showAvailableProperties('seller');
                }
            } else {
                alert('Error: No se pudo transferir la propiedad');
            }
        };

        // No need to register example properties as they will be stored in the database
        window.returnToHome = function() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('sellerContent').style.display = 'none';
            document.getElementById('buyerContent').style.display = 'none';
            document.getElementById('propertyListContainer').innerHTML = '';
        };
    </script>
</body>
</html>
